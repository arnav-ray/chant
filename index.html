<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Chanting App</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Lora', serif;
            background: linear-gradient(135deg, #FFF5E6 0%, #FFE4CC 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 140, 0, 0.2);
            padding: 40px;
            text-align: center;
        }

        h1 {
            color: #FF8C00;
            font-family: 'Crimson Text', serif;
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 140, 0, 0.3);
        }

        .subtitle {
            color: #D2691E;
            font-family: 'Lora', serif;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-style: italic;
            font-weight: 400;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Selection Screen */
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            color: #D2691E;
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #FFB366;
            border-radius: 10px;
            font-size: 1em;
            background: #FFF9F0;
            color: #8B4513;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #FF8C00;
        }

        .count-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .count-btn {
            padding: 15px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            color: #8B4513;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .count-btn:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .count-btn.active {
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border-color: #FF6347;
        }

        .chant-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .chant-btn {
            padding: 15px 10px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            color: #8B4513;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chant-btn:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .chant-btn.active {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-color: #1e40af;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, #FFE4CC 0%, #FFD4B3 100%);
            border-color: #FF8C00;
            box-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
        }

        .radio-option:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option span {
            color: #8B4513;
            font-size: 1em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(255, 140, 0, 0.4);
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 140, 0, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Chanting Screen */
        .chanting-canvas-container {
            position: relative;
            width: 100%;
            height: 350px;
            margin: 20px 0;
            background: linear-gradient(135deg, #FFF9F0 0%, #FFE4CC 100%);
            border-radius: 15px;
            border: 3px solid #FFB366;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .bottom-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
            margin: 30px 0 20px 0;
        }

        .mala-container {
            width: 200px;
            height: 200px;
            flex-shrink: 0;
        }

        #malaCanvas {
            width: 100%;
            height: 100%;
        }

        #chantingCanvas {
            max-width: 100%;
            max-height: 100%;
        }

        .counter {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 140, 0, 0.1);
            border-radius: 10px;
        }

        .counter-item {
            flex: 1;
            text-align: center;
        }

        .counter-label {
            color: #D2691E;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .counter-value {
            color: #FF8C00;
            font-size: 2em;
            font-weight: bold;
        }

        .chanting-screen .chant-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border: 5px solid #FFB366;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.5);
            flex-shrink: 0;
        }

        .chanting-screen .chant-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 140, 0, 0.7);
        }

        .chanting-screen .chant-btn:active {
            transform: scale(0.95);
        }

        .sound-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .sound-btn {
            padding: 10px 25px;
            background: #FFB366;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .sound-btn:hover {
            background: #FF8C00;
        }

        .sound-btn.playing {
            background: #32CD32;
        }

        /* Completion Screen */
        .completion-message {
            font-size: 2em;
            color: #FF8C00;
            margin: 30px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 140, 0, 0.3);
        }

        .completion-stats {
            background: rgba(255, 140, 0, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .completion-stats p {
            color: #D2691E;
            font-size: 1.3em;
            margin: 10px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .om-symbol {
            font-size: 4em;
            color: #FF8C00;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }

            .chanting-canvas-container {
                height: 280px;
            }

            .bottom-section {
                flex-direction: row;
                gap: 20px;
            }
            
            .chanting-screen .chant-btn {
                width: 150px;
                height: 150px;
                font-size: 1.2em;
            }

            .mala-container {
                width: 150px;
                height: 150px;
            }

            .chant-buttons {
                grid-template-columns: 1fr;
            }

            .count-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 601px) and (max-width: 900px) {
            .chanting-canvas-container {
                height: 320px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Selection Screen -->
        <div id="selectionScreen" class="screen active">
            <h1>🕉️ Chanting App</h1>
            <p class="subtitle">Begin Your Spiritual Journey</p>
            
            <div class="form-group">
                <label>Select Chant:</label>
                <div class="chant-buttons">
                    <button type="button" class="chant-btn active" data-chant="Om">Om</button>
                    <button type="button" class="chant-btn" data-chant="Radhe Radhe">Radhe Radhe</button>
                    <button type="button" class="chant-btn" data-chant="Hare Ram Hare Ram Ram Ram Hare Hare Hare Krishna Hare Krishna Krishna Krishna Hare Hare">Hare Ram Hare Krishna</button>
                    <button type="button" class="chant-btn" data-chant="Om Namah Shivaya">Om Namah Shivaya</button>
                    <button type="button" class="chant-btn" data-chant="Om Namo Bhagavate Vasudevaya">Om Namo Bhagavate Vasudevaya</button>
                    <button type="button" class="chant-btn" data-chant="Om Krishnaya Vasudevaya Haraye Paramatmane Pranatah Kleshanashaya Govindaya Namo Namah">Om Krishnaya Vasudevaya</button>
                    <button type="button" class="chant-btn" data-chant="Sarva Mangala Mangalye Shive Sarvartha Sadhike Sharanye Tryambake Gauri Narayani Namostute">Sarva Mangala Mangalye</button>
                </div>
                <input type="text" id="customChant" placeholder="Or enter your own chant...">
            </div>

            <div class="form-group">
                <label>Select Count:</label>
                <div class="count-buttons">
                    <button type="button" class="count-btn" data-count="9">9</button>
                    <button type="button" class="count-btn" data-count="12">12</button>
                    <button type="button" class="count-btn active" data-count="108">108</button>
                    <button type="button" class="count-btn" data-count="1008">1008</button>
                    <button type="button" class="count-btn" data-count="10008">10008</button>
                </div>
                <input type="number" id="customCount" placeholder="Or enter custom count..." min="1">
            </div>

            <div class="form-group">
                <label>Background Music:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="auto" checked>
                        <span>Auto-selected ambient sound</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="own">
                        <span>Upload your own music (MP3/WAV)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="none">
                        <span>No music (silent)</span>
                    </label>
                </div>
                <div id="musicUploadSection" style="display: none; margin-top: 10px;">
                    <input type="file" id="musicUpload" accept="audio/*" style="padding: 8px;">
                </div>
            </div>

            <button class="btn" onclick="startChanting()">Begin Chanting</button>
        </div>

        <!-- Chanting Screen -->
        <div id="chantingScreen" class="screen chanting-screen">
            <div class="chanting-canvas-container">
                <canvas id="chantingCanvas"></canvas>
            </div>

            <div class="counter">
                <div class="counter-item">
                    <div class="counter-label">Completed</div>
                    <div class="counter-value" id="completedCount">0</div>
                </div>
                <div class="counter-item">
                    <div class="counter-label">Remaining</div>
                    <div class="counter-value" id="remainingCount">0</div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="mala-container">
                    <canvas id="malaCanvas"></canvas>
                </div>
                
                <button class="chant-btn" onclick="chant()">CHANT</button>
            </div>

            <div class="sound-controls">
                <button class="sound-btn" id="pauseBtn" onclick="toggleSound()">Pause Music</button>
                <button class="sound-btn" onclick="goBack()">← Back</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="screen">
            <div class="om-symbol">🕉️</div>
            <h1>Congratulations!</h1>
            <p class="completion-message">You have completed your chanting session</p>
            
            <div class="completion-stats">
                <p><strong>Chant:</strong> <span id="completedChant"></span></p>
                <p><strong>Total Chants:</strong> <span id="totalChants"></span></p>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="continueChanting()">Continue Chanting</button>
                <button class="btn" onclick="newSession()">New Session</button>
            </div>
        </div>
    </div>

    <audio id="backgroundMusic" loop>
        <source src="" type="audio/mpeg">
    </audio>

    <script>
        // Global variables
        let currentChant = '';
        let totalCount = 0;
        let completedCount = 0;
        let canvas, ctx;
        let malaCanvas, malaCtx;
        let filledPositions = [];
        let soundEnabled = true;
        let audioContext, oscillator, gainNode;
        let isPlaying = false;
        let uploadedAudio = null;
        let selectedCount = 108;
        let selectedChant = 'Om';
        let malaRotation = 0;

        // ============================================
        // ANALYTICS SYSTEM (Invisible to Users)
        // ============================================
        const Analytics = {
            // Initialize analytics
            init: function() {
                if (!localStorage.getItem('chantingAppAnalytics')) {
                    const initialData = {
                        totalVisits: 0,
                        sessions: [],
                        chantStats: {},
                        totalChants: 0,
                        firstVisit: new Date().toISOString(),
                        lastVisit: null
                    };
                    localStorage.setItem('chantingAppAnalytics', JSON.stringify(initialData));
                }
                this.recordVisit();
            },

            // Record a page visit
            recordVisit: function() {
                const data = this.getData();
                data.totalVisits++;
                data.lastVisit = new Date().toISOString();
                this.saveData(data);
                console.log('📊 Visit recorded. Total visits:', data.totalVisits);
            },

            // Record when a chanting session starts
            recordSessionStart: function(chant, count, musicType) {
                const session = {
                    id: Date.now(),
                    chant: chant,
                    targetCount: count,
                    completedCount: 0,
                    musicType: musicType,
                    startTime: new Date().toISOString(),
                    endTime: null,
                    completed: false
                };
                
                const data = this.getData();
                data.sessions.push(session);
                this.saveData(data);
                
                console.log('🕉️ Session started:', session);
                return session.id;
            },

            // Record each chant
            recordChant: function(chant) {
                const data = this.getData();
                
                // Update chant statistics
                if (!data.chantStats[chant]) {
                    data.chantStats[chant] = {
                        name: chant,
                        totalCount: 0,
                        sessions: 0
                    };
                }
                data.chantStats[chant].totalCount++;
                data.totalChants++;
                
                // Update current session
                const currentSession = data.sessions[data.sessions.length - 1];
                if (currentSession) {
                    currentSession.completedCount++;
                }
                
                this.saveData(data);
            },

            // Record when session completes
            recordSessionComplete: function(chant, completedCount) {
                const data = this.getData();
                const currentSession = data.sessions[data.sessions.length - 1];
                
                if (currentSession) {
                    currentSession.endTime = new Date().toISOString();
                    currentSession.completed = true;
                    currentSession.completedCount = completedCount;
                }
                
                // Update chant stats
                if (data.chantStats[chant]) {
                    data.chantStats[chant].sessions++;
                }
                
                this.saveData(data);
                console.log('✅ Session completed:', currentSession);
            },

            // Get all analytics data
            getData: function() {
                return JSON.parse(localStorage.getItem('chantingAppAnalytics'));
            },

            // Save analytics data
            saveData: function(data) {
                localStorage.setItem('chantingAppAnalytics', JSON.stringify(data));
            },

            // Display KPIs in console (for admin viewing)
            showKPIs: function() {
                const data = this.getData();
                console.clear();
                console.log('═══════════════════════════════════════');
                console.log('📊 CHANTING APP ANALYTICS DASHBOARD');
                console.log('═══════════════════════════════════════');
                console.log('');
                console.log('📈 OVERVIEW:');
                console.log('  Total Visits:', data.totalVisits);
                console.log('  Total Sessions:', data.sessions.length);
                console.log('  Total Chants Completed:', data.totalChants);
                console.log('  First Visit:', new Date(data.firstVisit).toLocaleString());
                console.log('  Last Visit:', data.lastVisit ? new Date(data.lastVisit).toLocaleString() : 'N/A');
                console.log('');
                console.log('🕉️ CHANT STATISTICS:');
                
                // Sort chants by popularity
                const sortedChants = Object.values(data.chantStats)
                    .sort((a, b) => b.totalCount - a.totalCount);
                
                sortedChants.forEach((chant, index) => {
                    console.log(`  ${index + 1}. ${chant.name}`);
                    console.log(`     Total Chants: ${chant.totalCount}`);
                    console.log(`     Sessions: ${chant.sessions}`);
                    console.log(`     Avg per Session: ${chant.sessions > 0 ? Math.round(chant.totalCount / chant.sessions) : 0}`);
                });
                
                console.log('');
                console.log('📅 RECENT SESSIONS (Last 10):');
                const recentSessions = data.sessions.slice(-10).reverse();
                recentSessions.forEach((session, index) => {
                    const duration = session.endTime 
                        ? Math.round((new Date(session.endTime) - new Date(session.startTime)) / 1000 / 60)
                        : 'In Progress';
                    console.log(`  ${index + 1}. ${session.chant}`);
                    console.log(`     Target: ${session.targetCount}, Completed: ${session.completedCount}`);
                    console.log(`     Started: ${new Date(session.startTime).toLocaleString()}`);
                    console.log(`     Duration: ${duration} ${typeof duration === 'number' ? 'min' : ''}`);
                    console.log(`     Status: ${session.completed ? '✅ Completed' : '⏸️ Incomplete'}`);
                });
                
                console.log('');
                console.log('═══════════════════════════════════════');
                console.log('💡 TIP: Type Analytics.showKPIs() anytime to view this dashboard');
                console.log('💡 TIP: Type Analytics.exportData() to download data as JSON');
                console.log('═══════════════════════════════════════');
            },

            // Export data as downloadable JSON
            exportData: function() {
                const data = this.getData();
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `chanting-app-analytics-${Date.now()}.json`;
                link.click();
                console.log('✅ Analytics data exported!');
            },

            // Clear all analytics (use with caution)
            clearData: function() {
                if (confirm('Are you sure you want to clear all analytics data? This cannot be undone.')) {
                    localStorage.removeItem('chantingAppAnalytics');
                    this.init();
                    console.log('🗑️ Analytics data cleared and reset.');
                }
            }
        };

        // Initialize analytics when page loads
        Analytics.init();

        // Make Analytics available globally for console access
        window.Analytics = Analytics;

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Chant button selection
            document.querySelectorAll('.chant-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.chant-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedChant = this.dataset.chant;
                    document.getElementById('customChant').value = '';
                });
            });

            // Custom chant input
            document.getElementById('customChant').addEventListener('input', function() {
                if (this.value) {
                    document.querySelectorAll('.chant-btn').forEach(b => b.classList.remove('active'));
                    selectedChant = this.value.trim();
                }
            });

            // Count button selection
            document.querySelectorAll('.count-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    selectedCount = parseInt(this.dataset.count);
                    document.getElementById('customCount').value = '';
                });
            });

            // Custom count input
            document.getElementById('customCount').addEventListener('input', function() {
                if (this.value) {
                    document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
                    selectedCount = parseInt(this.value);
                }
            });

            // Music option radio buttons
            document.querySelectorAll('input[name="musicOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const uploadSection = document.getElementById('musicUploadSection');
                    uploadSection.style.display = this.value === 'own' ? 'block' : 'none';
                });
            });

            // Music upload
            document.getElementById('musicUpload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const url = URL.createObjectURL(file);
                    uploadedAudio = new Audio(url);
                    uploadedAudio.loop = true;
                }
            });
        });

        function startChanting() {
            const customChant = document.getElementById('customChant');
            const customCount = document.getElementById('customCount');
            const musicOption = document.querySelector('input[name="musicOption"]:checked').value;

            // Get chant from custom input or selected button
            if (customChant.value.trim()) {
                currentChant = customChant.value.trim();
            } else {
                currentChant = selectedChant;
            }

            // Get count from custom input or selected button
            if (customCount.value) {
                totalCount = parseInt(customCount.value);
                if (totalCount < 1) {
                    alert('Please enter a valid count (minimum 1)');
                    return;
                }
            } else {
                totalCount = selectedCount;
            }

            // Set sound based on music option
            soundEnabled = musicOption !== 'none';

            completedCount = 0;
            filledPositions = [];
            malaRotation = 0; // Reset mala rotation

            // 📊 Record session start
            Analytics.recordSessionStart(currentChant, totalCount, musicOption);

            // Switch screens
            document.getElementById('selectionScreen').classList.remove('active');
            document.getElementById('chantingScreen').classList.add('active');

            // Setup canvas
            setupCanvas();
            updateCounter();

            // Start background music
            if (soundEnabled) {
                if (musicOption === 'own' && uploadedAudio) {
                    startBackgroundMusic();
                } else if (musicOption === 'auto') {
                    startBackgroundMusic();
                }
            }
        }

        function setupCanvas() {
            canvas = document.getElementById('chantingCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 40;
            canvas.height = container.clientHeight - 40;

            // Setup mala canvas
            malaCanvas = document.getElementById('malaCanvas');
            malaCtx = malaCanvas.getContext('2d');
            malaCanvas.width = 200;
            malaCanvas.height = 200;
            
            drawChantWithFill();
            drawMala();
        }

        function drawMala() {
            if (!malaCtx) return;
            
            const centerX = malaCanvas.width / 2;
            const centerY = malaCanvas.height / 2;
            const radius = 80;
            
            // Clear canvas
            malaCtx.clearRect(0, 0, malaCanvas.width, malaCanvas.height);
            
            // Draw thread (string that connects beads)
            malaCtx.strokeStyle = '#8B4513';
            malaCtx.lineWidth = 2;
            malaCtx.beginPath();
            malaCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            malaCtx.stroke();
            
            // Calculate how many beads to draw
            const beadsToShow = Math.min(totalCount, 108); // Max 108 beads for visual clarity
            const beadSize = beadsToShow <= 27 ? 8 : beadsToShow <= 54 ? 6 : 4;
            
            // Draw beads
            for (let i = 0; i < beadsToShow; i++) {
                const angle = (i / beadsToShow) * Math.PI * 2 - Math.PI / 2 + malaRotation;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                // Determine if this bead is "completed"
                const beadProgress = (completedCount / totalCount) * beadsToShow;
                const isCompleted = i < beadProgress;
                
                // Draw bead
                malaCtx.beginPath();
                malaCtx.arc(x, y, beadSize, 0, Math.PI * 2);
                
                // Rudraksha color - brown/dark brown
                if (isCompleted) {
                    malaCtx.fillStyle = '#8B4513'; // Dark brown (completed)
                } else {
                    malaCtx.fillStyle = '#D2691E'; // Light brown (pending)
                }
                malaCtx.fill();
                
                // Add texture lines for rudraksha effect
                if (beadSize >= 6) {
                    malaCtx.strokeStyle = '#654321';
                    malaCtx.lineWidth = 1;
                    malaCtx.beginPath();
                    malaCtx.moveTo(x - beadSize * 0.6, y);
                    malaCtx.lineTo(x + beadSize * 0.6, y);
                    malaCtx.stroke();
                }
            }
            
            // Draw Guru bead (larger, at top)
            const guruAngle = -Math.PI / 2 + malaRotation;
            const guruX = centerX + radius * Math.cos(guruAngle);
            const guruY = centerY + radius * Math.sin(guruAngle);
            
            malaCtx.beginPath();
            malaCtx.arc(guruX, guruY, beadSize * 1.5, 0, Math.PI * 2);
            malaCtx.fillStyle = completedCount >= totalCount ? '#FF8C00' : '#8B4513';
            malaCtx.fill();
            malaCtx.strokeStyle = '#654321';
            malaCtx.lineWidth = 2;
            malaCtx.stroke();
            
            // Add tassel below guru bead
            malaCtx.strokeStyle = '#FF8C00';
            malaCtx.lineWidth = 3;
            malaCtx.beginPath();
            malaCtx.moveTo(guruX, guruY + beadSize * 1.5);
            malaCtx.lineTo(guruX, guruY + beadSize * 3);
            malaCtx.stroke();
            
            // Tassel strands
            for (let i = -2; i <= 2; i++) {
                malaCtx.strokeStyle = '#FF8C00';
                malaCtx.lineWidth = 1;
                malaCtx.beginPath();
                malaCtx.moveTo(guruX, guruY + beadSize * 3);
                malaCtx.lineTo(guruX + i * 3, guruY + beadSize * 4);
                malaCtx.stroke();
            }
        }

        function drawChantWithFill() {
            // Safety check: don't draw if currentChant is not set
            if (!currentChant || !ctx) return;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Calculate fill percentage
            const fillPercentage = completedCount / totalCount;
            
            // Dynamically calculate font size to fit the text
            let fontSize = 120;
            ctx.font = `bold ${fontSize}px Crimson Text`;
            let metrics = ctx.measureText(currentChant);
            
            // Check if text needs to wrap (too long for one line)
            const maxWidth = canvas.width * 0.85;
            let lines = [currentChant];
            
            // If text is very long, consider word wrapping
            if (metrics.width > maxWidth) {
                // Try to split into multiple lines for very long chants
                const words = currentChant.split(' ');
                if (words.length > 3) {
                    // Multi-word chant - try word wrapping
                    lines = [];
                    let currentLine = '';
                    
                    for (const word of words) {
                        const testLine = currentLine ? currentLine + ' ' + word : word;
                        ctx.font = `bold ${fontSize}px Crimson Text`;
                        const testMetrics = ctx.measureText(testLine);
                        
                        if (testMetrics.width > maxWidth && currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) {
                        lines.push(currentLine);
                    }
                    
                    // Adjust font size based on number of lines and canvas height
                    const maxHeight = canvas.height * 0.85;
                    const lineHeight = fontSize * 1.2;
                    const totalTextHeight = lines.length * lineHeight;
                    
                    if (totalTextHeight > maxHeight) {
                        fontSize = Math.floor((maxHeight / (lines.length * 1.2)));
                    }
                } else {
                    // Single word or short phrase - just reduce font size
                    while (metrics.width > maxWidth && fontSize > 30) {
                        fontSize -= 5;
                        ctx.font = `bold ${fontSize}px Crimson Text`;
                        metrics = ctx.measureText(currentChant);
                    }
                }
            }
            
            // Ensure font size is reasonable
            fontSize = Math.max(30, Math.min(120, fontSize));
            ctx.font = `bold ${fontSize}px Crimson Text`;
            
            // Recalculate line wrapping with final font size if needed
            if (lines.length > 1) {
                lines = [];
                let currentLine = '';
                const words = currentChant.split(' ');
                
                for (const word of words) {
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    ctx.font = `bold ${fontSize}px Crimson Text`;
                    const testMetrics = ctx.measureText(testLine);
                    
                    if (testMetrics.width > maxWidth && currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) {
                    lines.push(currentLine);
                }
            }
            
            // Draw the text (outline and fill)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const lineHeight = fontSize * 1.2;
            const totalHeight = lines.length * lineHeight;
            const startY = centerY - (totalHeight / 2) + (lineHeight / 2);
            
            lines.forEach((line, index) => {
                const yPos = startY + (index * lineHeight);
                
                // Draw outline
                ctx.strokeStyle = '#1e3a8a';
                ctx.lineWidth = 3;
                ctx.strokeText(line, centerX, yPos);
                
                // Draw fill if there's progress
                if (fillPercentage > 0) {
                    ctx.save();
                    
                    // Calculate fill color based on percentage
                    const startColor = { r: 255, g: 220, b: 180 }; // Light orange
                    const endColor = { r: 255, g: 140, b: 0 };      // Deep orange
                    
                    const r = Math.round(startColor.r + (endColor.r - startColor.r) * fillPercentage);
                    const g = Math.round(startColor.g + (endColor.g - startColor.g) * fillPercentage);
                    const b = Math.round(startColor.b + (endColor.b - startColor.b) * fillPercentage);
                    
                    // Calculate opacity - starts at 0.3, goes to 1.0
                    const opacity = 0.3 + (0.7 * fillPercentage);
                    
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                    ctx.fillText(line, centerX, yPos);
                    
                    ctx.restore();
                }
            });
        }

        function chant() {
            if (completedCount >= totalCount) {
                return;
            }

            completedCount++;
            
            // 📊 Record each chant
            Analytics.recordChant(currentChant);
            
            // Rotate mala
            const beadsToShow = Math.min(totalCount, 108);
            malaRotation += (Math.PI * 2) / beadsToShow;
            
            // Redraw with updated fill and mala
            drawChantWithFill();
            drawMala();
            updateCounter();

            // Play chant sound
            playChantSound();

            // Check completion
            if (completedCount >= totalCount) {
                setTimeout(showCompletion, 500);
            }
        }

        function updateCounter() {
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('remainingCount').textContent = totalCount - completedCount;
        }

        function startBackgroundMusic() {
            // If user uploaded their own music, use that
            if (uploadedAudio) {
                uploadedAudio.play().catch(err => {
                    console.log('Audio playback failed:', err);
                });
                isPlaying = true;
                document.getElementById('pauseBtn').textContent = 'Pause Music';
                document.getElementById('pauseBtn').classList.add('playing');
                return;
            }

            // Otherwise use synthesized sound (fallback)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Create simple drone sound
            if (oscillator) {
                oscillator.stop();
            }

            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            isPlaying = true;
            document.getElementById('pauseBtn').textContent = 'Pause Music';
            document.getElementById('pauseBtn').classList.add('playing');
        }

        function toggleSound() {
            if (!soundEnabled) return;

            if (uploadedAudio) {
                // Handle uploaded audio
                if (isPlaying) {
                    uploadedAudio.pause();
                    isPlaying = false;
                    document.getElementById('pauseBtn').textContent = 'Play Music';
                    document.getElementById('pauseBtn').classList.remove('playing');
                } else {
                    uploadedAudio.play();
                    isPlaying = true;
                    document.getElementById('pauseBtn').textContent = 'Pause Music';
                    document.getElementById('pauseBtn').classList.add('playing');
                }
            } else {
                // Handle synthesized sound
                if (isPlaying) {
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    isPlaying = false;
                    document.getElementById('pauseBtn').textContent = 'Play Music';
                    document.getElementById('pauseBtn').classList.remove('playing');
                } else {
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    isPlaying = true;
                    document.getElementById('pauseBtn').textContent = 'Pause Music';
                    document.getElementById('pauseBtn').classList.add('playing');
                }
            }
        }

        function playChantSound() {
            if (!soundEnabled || !audioContext) return;

            // Create a brief chime sound
            const chantOsc = audioContext.createOscillator();
            const chantGain = audioContext.createGain();

            chantOsc.frequency.setValueAtTime(440, audioContext.currentTime);
            chantGain.gain.setValueAtTime(0.2, audioContext.currentTime);
            chantGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            chantOsc.connect(chantGain);
            chantGain.connect(audioContext.destination);

            chantOsc.start(audioContext.currentTime);
            chantOsc.stop(audioContext.currentTime + 0.3);
        }

        function showCompletion() {
            // Stop music
            if (uploadedAudio) {
                uploadedAudio.pause();
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            // 📊 Record session completion
            Analytics.recordSessionComplete(currentChant, completedCount);

            // Update completion screen
            document.getElementById('completedChant').textContent = currentChant;
            document.getElementById('totalChants').textContent = totalCount;

            // Switch screens
            document.getElementById('chantingScreen').classList.remove('active');
            document.getElementById('completionScreen').classList.add('active');
        }

        function continueChanting() {
            // Add more chants to the current session
            const additionalCount = selectedCount || 108;
            totalCount += additionalCount;
            
            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('chantingScreen').classList.add('active');

            updateCounter();

            if (soundEnabled && !isPlaying) {
                startBackgroundMusic();
            }
        }

        function newSession() {
            // Reset everything
            if (uploadedAudio) {
                uploadedAudio.pause();
                uploadedAudio.currentTime = 0;
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('selectionScreen').classList.add('active');
        }

        function goBack() {
            // Stop music
            if (uploadedAudio) {
                uploadedAudio.pause();
                uploadedAudio.currentTime = 0;
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            // Confirm if they want to go back
            if (completedCount > 0) {
                if (confirm('Are you sure you want to go back? Your progress will be lost.')) {
                    document.getElementById('chantingScreen').classList.remove('active');
                    document.getElementById('selectionScreen').classList.add('active');
                }
            } else {
                document.getElementById('chantingScreen').classList.remove('active');
                document.getElementById('selectionScreen').classList.add('active');
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (canvas && ctx) {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth - 40;
                canvas.height = container.clientHeight - 40;
                drawChantWithFill();
            }
            if (malaCanvas && malaCtx) {
                drawMala();
            }
        });
    </script>
</body>
</html>
