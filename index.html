<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiritual Chanting App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #FFF5E6 0%, #FFE4CC 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(255, 140, 0, 0.2);
            padding: 40px;
            text-align: center;
        }

        h1 {
            color: #FF8C00;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 140, 0, 0.3);
        }

        .subtitle {
            color: #D2691E;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-style: italic;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Selection Screen */
        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        label {
            display: block;
            color: #D2691E;
            font-size: 1.1em;
            margin-bottom: 8px;
            font-weight: bold;
        }

        select, input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #FFB366;
            border-radius: 10px;
            font-size: 1em;
            background: #FFF9F0;
            color: #8B4513;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #FF8C00;
        }

        .count-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .count-btn {
            padding: 15px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            color: #8B4513;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .count-btn:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .count-btn.active {
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border-color: #FF6347;
        }

        .chant-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .chant-btn {
            padding: 15px 10px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            color: #8B4513;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chant-btn:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .chant-btn.active {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            border-color: #1e40af;
        }

        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #FFF9F0;
            border: 2px solid #FFB366;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .radio-option:has(input[type="radio"]:checked) {
            background: linear-gradient(135deg, #FFE4CC 0%, #FFD4B3 100%);
            border-color: #FF8C00;
            box-shadow: 0 2px 8px rgba(255, 140, 0, 0.3);
        }

        .radio-option:hover {
            background: #FFE4CC;
            border-color: #FF8C00;
        }

        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .radio-option span {
            color: #8B4513;
            font-size: 1em;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 5px 15px rgba(255, 140, 0, 0.4);
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 140, 0, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Chanting Screen */
        .chanting-canvas-container {
            position: relative;
            width: 100%;
            height: 450px;
            margin: 30px 0;
            background: linear-gradient(135deg, #FFF9F0 0%, #FFE4CC 100%);
            border-radius: 15px;
            border: 3px solid #FFB366;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #chantingCanvas {
            max-width: 100%;
            max-height: 100%;
        }

        .counter {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 140, 0, 0.1);
            border-radius: 10px;
        }

        .counter-item {
            flex: 1;
            text-align: center;
        }

        .counter-label {
            color: #D2691E;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .counter-value {
            color: #FF8C00;
            font-size: 2em;
            font-weight: bold;
        }

        .chant-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF8C00 0%, #FF6347 100%);
            color: white;
            border: 5px solid #FFB366;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            box-shadow: 0 10px 30px rgba(255, 140, 0, 0.5);
            margin: 20px auto;
        }

        .chant-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(255, 140, 0, 0.7);
        }

        .chant-btn:active {
            transform: scale(0.95);
        }

        .sound-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .sound-btn {
            padding: 10px 25px;
            background: #FFB366;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .sound-btn:hover {
            background: #FF8C00;
        }

        .sound-btn.playing {
            background: #32CD32;
        }

        /* Completion Screen */
        .completion-message {
            font-size: 2em;
            color: #FF8C00;
            margin: 30px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(255, 140, 0, 0.3);
        }

        .completion-stats {
            background: rgba(255, 140, 0, 0.1);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .completion-stats p {
            color: #D2691E;
            font-size: 1.3em;
            margin: 10px 0;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .om-symbol {
            font-size: 4em;
            color: #FF8C00;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .chant-btn {
                width: 150px;
                height: 150px;
                font-size: 1.2em;
            }

            .chant-buttons {
                grid-template-columns: 1fr;
            }

            .count-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Selection Screen -->
        <div id="selectionScreen" class="screen active">
            <h1>üïâÔ∏è Chanting App</h1>
            <p class="subtitle">Begin Your Spiritual Journey</p>
            
            <div class="form-group">
                <label>Select Chant:</label>
                <div class="chant-buttons">
                    <button type="button" class="chant-btn active" data-chant="Om">Om</button>
                    <button type="button" class="chant-btn" data-chant="Radhe Radhe">Radhe Radhe</button>
                    <button type="button" class="chant-btn" data-chant="Hare Ram Hare Ram Ram Ram Hare Hare Hare Krishna Hare Krishna Krishna Krishna Hare Hare">Hare Ram Hare Krishna</button>
                    <button type="button" class="chant-btn" data-chant="Om Namah Shivaya">Om Namah Shivaya</button>
                    <button type="button" class="chant-btn" data-chant="Om Namo Bhagavate Vasudevaya">Om Namo Bhagavate Vasudevaya</button>
                    <button type="button" class="chant-btn" data-chant="Om Krishnaya Vasudevaya Haraye Paramatmane Pranatah Kleshanashaya Govindaya Namo Namah">Om Krishnaya Vasudevaya</button>
                    <button type="button" class="chant-btn" data-chant="Sarva Mangala Mangalye Shive Sarvartha Sadhike Sharanye Tryambake Gauri Narayani Namostute">Sarva Mangala Mangalye</button>
                </div>
                <input type="text" id="customChant" placeholder="Or enter your own chant...">
            </div>

            <div class="form-group">
                <label>Select Count:</label>
                <div class="count-buttons">
                    <button type="button" class="count-btn" data-count="9">9</button>
                    <button type="button" class="count-btn active" data-count="108">108</button>
                    <button type="button" class="count-btn" data-count="1001">1001</button>
                    <button type="button" class="count-btn" data-count="10001">10001</button>
                </div>
                <input type="number" id="customCount" placeholder="Or enter custom count..." min="1">
            </div>

            <div class="form-group">
                <label>Background Music:</label>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="auto" checked>
                        <span>Auto-selected ambient sound</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="own">
                        <span>Upload your own music (MP3/WAV)</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="musicOption" value="none">
                        <span>No music (silent)</span>
                    </label>
                </div>
                <div id="musicUploadSection" style="display: none; margin-top: 10px;">
                    <input type="file" id="musicUpload" accept="audio/*" style="padding: 8px;">
                </div>
            </div>

            <button class="btn" onclick="startChanting()">Begin Chanting</button>
        </div>

        <!-- Chanting Screen -->
        <div id="chantingScreen" class="screen">
            <h1 id="chantTitle"></h1>
            
            <div class="chanting-canvas-container">
                <canvas id="chantingCanvas"></canvas>
            </div>

            <div class="counter">
                <div class="counter-item">
                    <div class="counter-label">Completed</div>
                    <div class="counter-value" id="completedCount">0</div>
                </div>
                <div class="counter-item">
                    <div class="counter-label">Remaining</div>
                    <div class="counter-value" id="remainingCount">0</div>
                </div>
            </div>

            <button class="chant-btn" onclick="chant()">CHANT</button>

            <div class="sound-controls">
                <button class="sound-btn" id="pauseBtn" onclick="toggleSound()">Pause Music</button>
                <button class="sound-btn" onclick="goBack()">‚Üê Back</button>
            </div>
        </div>

        <!-- Completion Screen -->
        <div id="completionScreen" class="screen">
            <div class="om-symbol">üïâÔ∏è</div>
            <h1>Congratulations!</h1>
            <p class="completion-message">You have completed your chanting session</p>
            
            <div class="completion-stats">
                <p><strong>Chant:</strong> <span id="completedChant"></span></p>
                <p><strong>Total Chants:</strong> <span id="totalChants"></span></p>
            </div>

            <div class="action-buttons">
                <button class="btn" onclick="continueChanting()">Continue Chanting</button>
                <button class="btn" onclick="newSession()">New Session</button>
            </div>
        </div>
    </div>

    <audio id="backgroundMusic" loop>
        <source src="" type="audio/mpeg">
    </audio>

    <script>
        // Global variables
        let currentChant = '';
        let totalCount = 0;
        let completedCount = 0;
        let canvas, ctx;
        let filledPositions = [];
        let soundEnabled = true;
        let audioContext, oscillator, gainNode;
        let isPlaying = false;
        let uploadedAudio = null;
        let selectedCount = 108;
        let selectedChant = 'Om';

        // Chant button selection
        document.querySelectorAll('.chant-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.chant-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedChant = this.dataset.chant;
                document.getElementById('customChant').value = '';
            });
        });

        // Custom chant input
        document.getElementById('customChant').addEventListener('input', function() {
            if (this.value) {
                document.querySelectorAll('.chant-btn').forEach(b => b.classList.remove('active'));
                selectedChant = this.value.trim();
            }
        });

        // Count button selection
        document.querySelectorAll('.count-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedCount = parseInt(this.dataset.count);
                document.getElementById('customCount').value = '';
            });
        });

        // Custom count input
        document.getElementById('customCount').addEventListener('input', function() {
            if (this.value) {
                document.querySelectorAll('.count-btn').forEach(b => b.classList.remove('active'));
                selectedCount = parseInt(this.value);
            }
        });

        // Music option radio buttons
        document.querySelectorAll('input[name="musicOption"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const uploadSection = document.getElementById('musicUploadSection');
                uploadSection.style.display = this.value === 'own' ? 'block' : 'none';
            });
        });

        // Music upload
        document.getElementById('musicUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                uploadedAudio = new Audio(url);
                uploadedAudio.loop = true;
            }
        });

        function startChanting() {
            const customChant = document.getElementById('customChant');
            const customCount = document.getElementById('customCount');
            const musicOption = document.querySelector('input[name="musicOption"]:checked').value;

            // Get chant from custom input or selected button
            if (customChant.value.trim()) {
                currentChant = customChant.value.trim();
            } else {
                currentChant = selectedChant;
            }

            // Get count from custom input or selected button
            if (customCount.value) {
                totalCount = parseInt(customCount.value);
                if (totalCount < 1) {
                    alert('Please enter a valid count (minimum 1)');
                    return;
                }
            } else {
                totalCount = selectedCount;
            }

            // Set sound based on music option
            soundEnabled = musicOption !== 'none';

            completedCount = 0;
            filledPositions = [];

            // Switch screens
            document.getElementById('selectionScreen').classList.remove('active');
            document.getElementById('chantingScreen').classList.add('active');

            // Setup canvas
            setupCanvas();
            updateCounter();

            // Start background music
            if (soundEnabled) {
                if (musicOption === 'own' && uploadedAudio) {
                    startBackgroundMusic();
                } else if (musicOption === 'auto') {
                    startBackgroundMusic();
                }
            }

            document.getElementById('chantTitle').textContent = currentChant;
        }

        function setupCanvas() {
            canvas = document.getElementById('chantingCanvas');
            ctx = canvas.getContext('2d');
            
            // Set canvas size
            const container = canvas.parentElement;
            canvas.width = container.clientWidth - 40;
            canvas.height = container.clientHeight - 40;

            drawChantWithFill();
        }

        function drawChantWithFill() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Calculate fill percentage
            const fillPercentage = completedCount / totalCount;
            
            // Dynamically calculate font size to fit the text
            let fontSize = 120;
            ctx.font = `bold ${fontSize}px Georgia`;
            let metrics = ctx.measureText(currentChant);
            
            // Check if text needs to wrap (too long for one line)
            const maxWidth = canvas.width * 0.85;
            let lines = [currentChant];
            
            // If text is very long, consider word wrapping
            if (metrics.width > maxWidth) {
                // Try to split into multiple lines for very long chants
                const words = currentChant.split(' ');
                if (words.length > 3) {
                    // Multi-word chant - try word wrapping
                    lines = [];
                    let currentLine = '';
                    
                    for (const word of words) {
                        const testLine = currentLine ? currentLine + ' ' + word : word;
                        ctx.font = `bold ${fontSize}px Georgia`;
                        const testMetrics = ctx.measureText(testLine);
                        
                        if (testMetrics.width > maxWidth && currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) {
                        lines.push(currentLine);
                    }
                    
                    // Adjust font size based on number of lines and canvas height
                    const maxHeight = canvas.height * 0.85;
                    const lineHeight = fontSize * 1.2;
                    const totalTextHeight = lines.length * lineHeight;
                    
                    if (totalTextHeight > maxHeight) {
                        fontSize = Math.floor((maxHeight / (lines.length * 1.2)));
                    }
                } else {
                    // Single word or short phrase - just reduce font size
                    while (metrics.width > maxWidth && fontSize > 30) {
                        fontSize -= 5;
                        ctx.font = `bold ${fontSize}px Georgia`;
                        metrics = ctx.measureText(currentChant);
                    }
                }
            }
            
            // Ensure font size is reasonable
            fontSize = Math.max(30, Math.min(120, fontSize));
            ctx.font = `bold ${fontSize}px Georgia`;
            
            // Recalculate line wrapping with final font size if needed
            if (lines.length > 1) {
                lines = [];
                let currentLine = '';
                const words = currentChant.split(' ');
                
                for (const word of words) {
                    const testLine = currentLine ? currentLine + ' ' + word : word;
                    ctx.font = `bold ${fontSize}px Georgia`;
                    const testMetrics = ctx.measureText(testLine);
                    
                    if (testMetrics.width > maxWidth && currentLine) {
                        lines.push(currentLine);
                        currentLine = word;
                    } else {
                        currentLine = testLine;
                    }
                }
                if (currentLine) {
                    lines.push(currentLine);
                }
            }
            
            // Draw the text (outline and fill)
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const lineHeight = fontSize * 1.2;
            const totalHeight = lines.length * lineHeight;
            const startY = centerY - (totalHeight / 2) + (lineHeight / 2);
            
            lines.forEach((line, index) => {
                const yPos = startY + (index * lineHeight);
                
                // Draw outline
                ctx.strokeStyle = '#FF8C00';
                ctx.lineWidth = 3;
                ctx.strokeText(line, centerX, yPos);
                
                // Draw fill if there's progress
                if (fillPercentage > 0) {
                    ctx.save();
                    
                    // Calculate fill color based on percentage
                    const startColor = { r: 255, g: 220, b: 180 }; // Light orange
                    const endColor = { r: 255, g: 140, b: 0 };      // Deep orange
                    
                    const r = Math.round(startColor.r + (endColor.r - startColor.r) * fillPercentage);
                    const g = Math.round(startColor.g + (endColor.g - startColor.g) * fillPercentage);
                    const b = Math.round(startColor.b + (endColor.b - startColor.b) * fillPercentage);
                    
                    // Calculate opacity - starts at 0.3, goes to 1.0
                    const opacity = 0.3 + (0.7 * fillPercentage);
                    
                    ctx.fillStyle = `rgba(${r}, ${g}, ${b}, ${opacity})`;
                    ctx.fillText(line, centerX, yPos);
                    
                    ctx.restore();
                }
            });
        }

        function chant() {
            if (completedCount >= totalCount) {
                return;
            }

            completedCount++;
            
            // Redraw with updated fill
            drawChantWithFill();
            updateCounter();

            // Play chant sound
            playChantSound();

            // Check completion
            if (completedCount >= totalCount) {
                setTimeout(showCompletion, 500);
            }
        }

        function updateCounter() {
            document.getElementById('completedCount').textContent = completedCount;
            document.getElementById('remainingCount').textContent = totalCount - completedCount;
        }

        function startBackgroundMusic() {
            // If user uploaded their own music, use that
            if (uploadedAudio) {
                uploadedAudio.play().catch(err => {
                    console.log('Audio playback failed:', err);
                });
                isPlaying = true;
                document.getElementById('pauseBtn').textContent = 'Pause Music';
                document.getElementById('pauseBtn').classList.add('playing');
                return;
            }

            // Otherwise use synthesized sound (fallback)
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Create simple drone sound
            if (oscillator) {
                oscillator.stop();
            }

            oscillator = audioContext.createOscillator();
            gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            isPlaying = true;
            document.getElementById('pauseBtn').textContent = 'Pause Music';
            document.getElementById('pauseBtn').classList.add('playing');
        }

        function toggleSound() {
            if (!soundEnabled) return;

            if (uploadedAudio) {
                // Handle uploaded audio
                if (isPlaying) {
                    uploadedAudio.pause();
                    isPlaying = false;
                    document.getElementById('pauseBtn').textContent = 'Play Music';
                    document.getElementById('pauseBtn').classList.remove('playing');
                } else {
                    uploadedAudio.play();
                    isPlaying = true;
                    document.getElementById('pauseBtn').textContent = 'Pause Music';
                    document.getElementById('pauseBtn').classList.add('playing');
                }
            } else {
                // Handle synthesized sound
                if (isPlaying) {
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    isPlaying = false;
                    document.getElementById('pauseBtn').textContent = 'Play Music';
                    document.getElementById('pauseBtn').classList.remove('playing');
                } else {
                    gainNode.gain.setValueAtTime(0.08, audioContext.currentTime);
                    isPlaying = true;
                    document.getElementById('pauseBtn').textContent = 'Pause Music';
                    document.getElementById('pauseBtn').classList.add('playing');
                }
            }
        }

        function playChantSound() {
            if (!soundEnabled || !audioContext) return;

            // Create a brief chime sound
            const chantOsc = audioContext.createOscillator();
            const chantGain = audioContext.createGain();

            chantOsc.frequency.setValueAtTime(440, audioContext.currentTime);
            chantGain.gain.setValueAtTime(0.2, audioContext.currentTime);
            chantGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

            chantOsc.connect(chantGain);
            chantGain.connect(audioContext.destination);

            chantOsc.start(audioContext.currentTime);
            chantOsc.stop(audioContext.currentTime + 0.3);
        }

        function showCompletion() {
            // Stop music
            if (uploadedAudio) {
                uploadedAudio.pause();
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            // Update completion screen
            document.getElementById('completedChant').textContent = currentChant;
            document.getElementById('totalChants').textContent = totalCount;

            // Switch screens
            document.getElementById('chantingScreen').classList.remove('active');
            document.getElementById('completionScreen').classList.add('active');
        }

        function continueChanting() {
            // Add more chants to the current session
            const additionalCount = selectedCount || 108;
            totalCount += additionalCount;
            
            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('chantingScreen').classList.add('active');

            updateCounter();

            if (soundEnabled && !isPlaying) {
                startBackgroundMusic();
            }
        }

        function newSession() {
            // Reset everything
            if (uploadedAudio) {
                uploadedAudio.pause();
                uploadedAudio.currentTime = 0;
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            document.getElementById('completionScreen').classList.remove('active');
            document.getElementById('selectionScreen').classList.add('active');
        }

        function goBack() {
            // Stop music
            if (uploadedAudio) {
                uploadedAudio.pause();
                uploadedAudio.currentTime = 0;
            }
            if (oscillator) {
                oscillator.stop();
            }
            isPlaying = false;

            // Confirm if they want to go back
            if (completedCount > 0) {
                if (confirm('Are you sure you want to go back? Your progress will be lost.')) {
                    document.getElementById('chantingScreen').classList.remove('active');
                    document.getElementById('selectionScreen').classList.add('active');
                }
            } else {
                document.getElementById('chantingScreen').classList.remove('active');
                document.getElementById('selectionScreen').classList.add('active');
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (canvas && ctx) {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth - 40;
                canvas.height = container.clientHeight - 40;
                drawChantWithFill();
            }
        });
    </script>
</body>
</html>
